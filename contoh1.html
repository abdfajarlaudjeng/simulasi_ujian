<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ujian Online Informatika</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.nomor-soal {width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;margin:3px;cursor:pointer;border:2px solid #1e3a8a;transition:all 0.2s;font-size:14px;}
.nomor-soal:hover {background-color:#e0f2fe;}
.nomor-soal.active {background-color:#1e3a8a;color:white;}
.nomor-soal.answered {background-color:#16a34a;color:white;}
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">

<header class="bg-[#1e3a8a] text-white py-4 shadow-md text-center">
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Logo_Kemdikbud.svg/120px-Logo_Kemdikbud.svg.png" class="w-16 mx-auto mb-2">
  <h1 class="text-xl sm:text-2xl font-bold">Ujian Online Informatika SMP</h1>
  <p class="text-sm sm:text-base text-blue-100">Sistem Penilaian Otomatis</p>
</header>

<main class="flex-grow p-4 sm:p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-4 sm:p-6 flex flex-col lg:flex-row">

    <!-- Kiri: Login & Soal -->
    <div class="flex-1 lg:pr-6 border-gray-200 flex flex-col items-center justify-center">

      <p id="timer" class="text-left text-red-600 font-semibold mb-4 hidden"></p>

      <!-- Form Login -->
      <div id="loginSection" class="flex flex-col justify-center items-center w-full max-w-xs">
        <h2 class="text-xl font-semibold mb-4 text-center">Masuk untuk Mulai Ujian</h2>

        <div class="flex items-center w-full mb-3">
          <label class="w-20">Nama:</label>
          <input id="nama" class="border rounded w-full p-2 text-sm" placeholder="Nama">
        </div>

        <div class="flex items-center w-full mb-3">
          <label class="w-20">Kelas:</label>
          <input id="kelas" class="border rounded w-full p-2 text-sm" placeholder="Kelas">
        </div>

        <div class="flex items-center w-full mb-4">
          <label class="w-20">Token:</label>
          <input id="token" class="border rounded w-full p-2 text-sm" placeholder="Token">
        </div>

        <button onclick="mulaiUjian()" class="bg-[#1e3a8a] hover:bg-blue-900 text-white px-4 py-2 rounded w-full text-sm">
          Mulai Ujian
        </button>
      </div>

      <!-- Bagian Ujian -->
      <div id="ujianSection" class="hidden mt-4 w-full max-w-xl">
        <div id="soalContainer" class="mb-6"></div>
        <div class="flex justify-between mt-4">
          <button onclick="prevSoal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded text-sm">Sebelumnya</button>
          <button onclick="nextSoal()" class="bg-[#1e3a8a] hover:bg-blue-900 text-white px-4 py-2 rounded text-sm">Selanjutnya</button>
        </div>
        <button onclick="selesaiUjian()" class="mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full text-sm">Selesai Ujian</button>
      </div>

    </div>

    <!-- Kanan: Nomor Soal -->
    <div id="panelNomor" class="lg:w-1/3 border-t lg:border-t-0 lg:border-l mt-6 lg:mt-0 lg:pl-4 hidden">
      <h2 class="text-lg font-semibold mb-3">Nomor Soal</h2>
      <div id="nomorContainer" class="flex flex-wrap"></div>
    </div>

  </div>
</main>

<footer class="bg-[#1e3a8a] text-gray-200 text-center text-sm py-4">© 2025 Ujian Online Informatika</footer>

<!-- Modal Konfirmasi -->
<div id="confirmModal" class="hidden fixed inset-0 flex justify-center items-center bg-black/40 z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full text-center">
    <p class="text-lg mb-4">Apakah Anda yakin ingin mengirim hasil ujian?</p>
    <div class="flex justify-around">
      <button onclick="kirimHasil()" class="bg-green-600 text-white px-4 py-2 rounded">Ya</button>
      <button onclick="tutupModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Batal</button>
    </div>
  </div>
</div>

<script>
const scriptURL="https://script.google.com/macros/s/AKfycbwzSQV9vCNbzVc4RFe-1rnpcoB_HWX7W_6u1oTWB7pFbw6J3f0AlvVKFW8VK2tPUvWTVQ/exec";
let soalData=[],jawaban={},nama="",kelas="",currentSoal=0;
let waktuTersisa=60*60,timerInterval;

async function mulaiUjian(){
  nama=document.getElementById("nama").value.trim();
  kelas=document.getElementById("kelas").value.trim();
  const tokenInput=document.getElementById("token").value.trim();
  if(!nama||!kelas||!tokenInput) return alert("Harap isi semua kolom");

  const resToken=await fetch(`${scriptURL}?action=cekToken&token=${tokenInput}`);
  const dataToken=await resToken.json();
  if(!dataToken.valid) return alert("Token salah!");

  localStorage.setItem("nama",nama);
  localStorage.setItem("kelas",kelas);

  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("ujianSection").classList.remove("hidden");
  document.getElementById("panelNomor").classList.remove("hidden");
  document.getElementById("timer").classList.remove("hidden");

  const res=await fetch(`${scriptURL}?action=getSoal`);
  soalData=(await res.json()).questions.sort(()=>Math.random()-0.5);

  jawaban=JSON.parse(localStorage.getItem("jawaban")||"{}");
  const savedTime=localStorage.getItem("waktuTersisa");
  if(savedTime) waktuTersisa=parseInt(savedTime);

  tampilkanNomorSoal();
  tampilkanSoal(currentSoal);
  mulaiTimer();
}

function tampilkanNomorSoal(){
  const container=document.getElementById("nomorContainer");
  container.innerHTML="";
  soalData.forEach((_,i)=>{
    const div=document.createElement("div");
    div.textContent=i+1;
    div.className="nomor-soal";
    div.onclick=()=>tampilkanSoal(i);
    container.appendChild(div);
  });
  updateNomorStatus();
}

function tampilkanSoal(i){
  currentSoal=i;
  const s=soalData[i];
  const c=document.getElementById("soalContainer");
  c.innerHTML=`<p class="font-semibold mb-2">Soal ${i+1} dari ${soalData.length}</p>
  <p class="mb-4">${s.soal}</p>
  ${s.pilihan.map((p,idx)=>`<label class="block mb-2"><input type="radio" name="soal${i}" value="${p}" ${jawaban[i]===p?"checked":""} onchange="pilihJawaban(${i},'${p}')"> ${String.fromCharCode(65+idx)}. ${p}</label>`).join("")}`;
  updateNomorStatus();
}

function pilihJawaban(i,val){jawaban[i]=val;localStorage.setItem("jawaban",JSON.stringify(jawaban));updateNomorStatus();}
function prevSoal(){if(currentSoal>0)tampilkanSoal(currentSoal-1);}
function nextSoal(){if(currentSoal<soalData.length-1)tampilkanSoal(currentSoal+1);}
function updateNomorStatus(){document.querySelectorAll(".nomor-soal").forEach((b,i)=>{b.classList.remove("active","answered");if(i===currentSoal)b.classList.add("active");if(jawaban[i])b.classList.add("answered");});}

function mulaiTimer(){clearInterval(timerInterval);timerInterval=setInterval(()=>{waktuTersisa--;localStorage.setItem("waktuTersisa",waktuTersisa);const menit=Math.floor(waktuTersisa/60);const detik=waktuTersisa%60;document.getElementById("timer").textContent=`⏰ Sisa waktu: ${menit}:${detik.toString().padStart(2,"0")}`;if(waktuTersisa<=0){clearInterval(timerInterval);alert("Waktu habis! Jawaban otomatis dikirim.");kirimHasil();}},1000);}

function selesaiUjian(){document.getElementById("confirmModal").classList.remove("hidden");}
function tutupModal(){document.getElementById("confirmModal").classList.add("hidden");}

async function kirimHasil(){
  tutupModal();clearInterval(timerInterval);
  let skor=0;soalData.forEach((s,i)=>{if(jawaban[i]&&jawaban[i].trim().toLowerCase()===s.kunci.trim().toLowerCase())skor++;});
  const data=new FormData();
  data.append("action","submitJawaban");
  data.append("nama",nama);
  data.append("kelas",kelas);
  data.append("skor",skor);
  await fetch(scriptURL,{method:"POST",body:data});
  localStorage.clear();
  alert(`Ujian selesai! Skor Anda: ${skor}/${soalData.length}`);
  window.location.reload();
}

window.addEventListener("load",()=>{if(localStorage.getItem("nama")&&localStorage.getItem("kelas")){nama=localStorage.getItem("nama");kelas=localStorage.getItem("kelas");mulaiUjian();}});
</script>
</body>
</html>
