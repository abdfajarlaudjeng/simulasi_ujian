<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ujian Online Informatika</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .nomor-soal {
      width: 40px; height: 40px;
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      margin: 4px; cursor: pointer;
      border: 2px solid #3b82f6;
      transition: all 0.2s;
    }
    .nomor-soal:hover { background-color: #e0f2fe; }
    .nomor-soal.active { background-color: #3b82f6; color: white; }
    .nomor-soal.answered { background-color: #16a34a; color: white; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6 font-sans">
  <div class="max-w-5xl mx-auto bg-white rounded-lg shadow-md p-6 flex flex-col lg:flex-row">
    
    <!-- Bagian kiri -->
    <div class="flex-1 lg:pr-6 border-gray-200">
      <h1 class="text-2xl font-bold text-center mb-2">Ujian Online Informatika</h1>
      <p id="timer" class="text-center text-red-600 font-semibold mb-4 hidden"></p>

      <div id="loginSection">
        <label class="block mb-2">Nama:</label>
        <input id="nama" type="text" class="border rounded w-full p-2 mb-3" placeholder="Masukkan nama Anda">
        <label class="block mb-2">Kelas:</label>
        <input id="kelas" type="text" class="border rounded w-full p-2 mb-3" placeholder="Masukkan kelas Anda">
        <button onclick="mulaiUjian()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full">Mulai Ujian</button>
      </div>

      <div id="ujianSection" class="hidden">
        <div id="soalContainer" class="mb-6"></div>
        <div class="flex justify-between mt-4">
          <button id="prevBtn" onclick="prevSoal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">Sebelumnya</button>
          <button id="nextBtn" onclick="nextSoal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Selanjutnya</button>
        </div>
        <button onclick="selesaiUjian()" class="mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">Selesai Ujian</button>
      </div>
    </div>

    <!-- Bagian kanan -->
    <div id="panelNomor" class="lg:w-1/4 border-t lg:border-t-0 lg:border-l mt-6 lg:mt-0 lg:pl-4 hidden">
      <h2 class="text-lg font-semibold mb-3">Nomor Soal</h2>
      <div id="nomorContainer" class="flex flex-wrap"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm text-center">
      <p class="text-lg mb-4">Apakah Anda yakin ingin mengirim hasil ujian?</p>
      <div class="flex justify-around">
        <button onclick="kirimHasil()" class="bg-green-600 text-white px-4 py-2 rounded">Ya</button>
        <button onclick="tutupModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Batal</button>
      </div>
    </div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxzAwHIsjd2nu_-ojogrgNZb6_I2lMkxCLvCtTxBZuxJ8kkVSn8WJoy0lrkM1Gh1UFIlQ/exec"; // Ganti dengan URL kamu
    let soalData = [], jawaban = {}, nama = "", kelas = "", currentSoal = 0;
    let waktuTersisa = 30 * 60; // 30 menit dalam detik
    let timerInterval;

    async function mulaiUjian() {
      nama = document.getElementById("nama").value.trim();
      kelas = document.getElementById("kelas").value.trim();
      if (!nama || !kelas) return alert("Harap isi nama dan kelas.");

      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("ujianSection").classList.remove("hidden");
      document.getElementById("panelNomor").classList.remove("hidden");
      document.getElementById("timer").classList.remove("hidden");

      const res = await fetch(`${scriptURL}?action=getSoal`);
      soalData = (await res.json()).questions;
      soalData = soalData.sort(() => Math.random() - 0.5); // acak soal

      tampilkanNomorSoal();
      tampilkanSoal(0);
      mulaiTimer();
    }

    function tampilkanNomorSoal() {
      const container = document.getElementById("nomorContainer");
      container.innerHTML = "";
      soalData.forEach((_, i) => {
        const div = document.createElement("div");
        div.textContent = i + 1;
        div.className = "nomor-soal";
        div.onclick = () => tampilkanSoal(i);
        container.appendChild(div);
      });
      updateNomorStatus();
    }

    function tampilkanSoal(i) {
      currentSoal = i;
      const soal = soalData[i];
      const container = document.getElementById("soalContainer");
      container.innerHTML = `
        <p class="font-semibold mb-2">Soal ${i + 1} dari ${soalData.length}</p>
        <p class="mb-4">${soal.soal}</p>
        ${soal.pilihan.map((p, idx) => `
          <label class="block mb-2">
            <input type="radio" name="soal${i}" value="${p}" ${jawaban[i] === p ? "checked" : ""} onchange="jawaban[${i}] = this.value; updateNomorStatus()">
            ${String.fromCharCode(65 + idx)}. ${p}
          </label>
        `).join("")}
      `;
      updateNomorStatus();
    }

    function prevSoal() { if (currentSoal > 0) tampilkanSoal(currentSoal - 1); }
    function nextSoal() { if (currentSoal < soalData.length - 1) tampilkanSoal(currentSoal + 1); }

    function updateNomorStatus() {
      document.querySelectorAll(".nomor-soal").forEach((box, i) => {
        box.classList.remove("active", "answered");
        if (i === currentSoal) box.classList.add("active");
        if (jawaban[i]) box.classList.add("answered");
      });
    }

    function mulaiTimer() {
      timerInterval = setInterval(() => {
        waktuTersisa--;
        const menit = Math.floor(waktuTersisa / 60);
        const detik = waktuTersisa % 60;
        document.getElementById("timer").textContent = `Sisa waktu: ${menit}:${detik.toString().padStart(2, "0")}`;

        if (waktuTersisa <= 0) {
          clearInterval(timerInterval);
          alert("Waktu habis! Jawaban otomatis dikirim.");
          kirimHasil();
        }
      }, 1000);
    }

    function selesaiUjian() {
      document.getElementById("confirmModal").classList.remove("hidden");
    }

    function tutupModal() {
      document.getElementById("confirmModal").classList.add("hidden");
    }

    async function kirimHasil() {
      tutupModal();
      clearInterval(timerInterval);

      let skor = 0;
      soalData.forEach((soal, i) => {
        if (jawaban[i] && jawaban[i].trim().toLowerCase() === soal.kunci.trim().toLowerCase()) skor++;
      });

      const data = new FormData();
      data.append("action", "submitJawaban");
      data.append("nama", nama);
      data.append("kelas", kelas);
      data.append("skor", skor);
      data.append("jawaban", JSON.stringify(jawaban));

      await fetch(scriptURL, { method: "POST", body: data });

      alert(`Ujian selesai! Skor Anda: ${skor}/${soalData.length}`);
      window.location.reload();
    }
  </script>
</body>
</html>
