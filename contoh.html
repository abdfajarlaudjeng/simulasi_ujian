<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ujian Online Informatika</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">

  <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
    <h1 class="text-2xl font-bold text-center mb-4">Ujian Online Informatika</h1>

    <div id="loginSection">
      <label class="block mb-2">Nama:</label>
      <input id="nama" type="text" class="border rounded w-full p-2 mb-3" placeholder="Masukkan nama Anda">

      <label class="block mb-2">Kelas:</label>
      <input id="kelas" type="text" class="border rounded w-full p-2 mb-3" placeholder="Masukkan kelas Anda">

      <button onclick="mulaiUjian()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full">Mulai Ujian</button>
    </div>

    <div id="ujianSection" class="hidden">
      <div id="soalContainer" class="mb-4"></div>
      <button onclick="selesaiUjian()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">Selesai Ujian</button>
    </div>
  </div>

  <!-- Modal Konfirmasi -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm text-center">
      <p class="text-lg mb-4">Apakah Anda yakin ingin mengirim hasil ujian?</p>
      <div class="flex justify-around">
        <button onclick="kirimHasil()" class="bg-green-600 text-white px-4 py-2 rounded">Ya</button>
        <button onclick="tutupModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Batal</button>
      </div>
    </div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbw1uQsAHJalT-04Ng3GmQ-4DwWPKnac6gLM5mcJy68EE0q8CFBeSJ4dn0vYYRCpP0DoKA/exec"; // Ganti dengan URL Web App yang kamu deploy
    let soalData = [];
    let jawaban = {};
    let nama = "", kelas = "";

    async function mulaiUjian() {
      nama = document.getElementById("nama").value.trim();
      kelas = document.getElementById("kelas").value.trim();

      if (!nama || !kelas) return alert("Harap isi nama dan kelas.");

      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("ujianSection").classList.remove("hidden");

      const res = await fetch(`${scriptURL}?action=getSoal`);
      soalData = await res.json();

      tampilkanSoal();
    }

    function tampilkanSoal() {
      const container = document.getElementById("soalContainer");
      container.innerHTML = soalData.map((soal, i) => `
        <div class="mb-4 border-b pb-3">
          <p class="font-semibold">${i + 1}. ${soal.pertanyaan}</p>
          ${soal.pilihan.map((p, idx) => `
            <label class="block">
              <input type="radio" name="soal${i}" value="${String.fromCharCode(65 + idx)}" onchange="jawaban[${i}] = this.value">
              ${String.fromCharCode(65 + idx)}. ${p}
            </label>
          `).join('')}
        </div>
      `).join('');
    }

    function selesaiUjian() {
      document.getElementById("confirmModal").classList.remove("hidden");
    }

    function tutupModal() {
      document.getElementById("confirmModal").classList.add("hidden");
    }

    async function kirimHasil() {
      tutupModal();
      let skor = 0;
      soalData.forEach((soal, i) => {
        if (jawaban[i] === soal.jawabanBenar) skor++;
      });

      const waktuSelesai = new Date().toLocaleString("id-ID");
      const data = { action: "submitHasil", nama, kelas, skor, jawaban, waktuSelesai };

      await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(data)
      });

      alert(`Ujian selesai! Skor Anda: ${skor}/${soalData.length}`);
      window.location.reload();
    }

    // Peringatan sebelum keluar halaman
    window.addEventListener("beforeunload", (e) => {
      if (Object.keys(jawaban).length < soalData.length) {
        e.preventDefault();
        e.returnValue = "Ujian belum dikumpulkan. Yakin ingin keluar?";
      }
    });
  </script>
</body>
</html>
